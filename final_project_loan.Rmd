Final Project by Wonjun Lee
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

suppressMessages(library(ggplot2))
```

```{r echo=FALSE, Load_the_Data}
# Load the Data
df <- read.csv("c:/udacity/data-analysis-with-R/prosperLoanData.csv")
names(df)
```

# Univariate Plots Section
```{r echo=FALSE, Univariate_Plots}
dim(df)
summary(df)
str(df)
```

There are 81 variables with 113937 observations.
Plotting a histogram for each variable will be helpful in understanding the data set. I will only use variables that are not factors.

### Finding good variables
```{r}
library(dplyr)

colSums(is.na(df))
```

This will help me filter out variables with too many NA's.

### Term
```{r}
ggplot(aes(x=Term), data=df) +
  geom_histogram(bins=30)
```

There are only 3 terms people use. More specifically,

```{r}
table(df$Term)
df$Term <- factor(df$Term)
```

12, 36 and 60. Term will be used as a factored variable.

### Borrower Rate, Borrower APR, Lender Yield, EstimatedEffectiveYield
```{r}
ggplot(aes(x=BorrowerAPR), data=df) +
  geom_histogram(bins=100)
ggplot(aes(x=BorrowerRate), data=df) +
  geom_histogram(bins=100)
ggplot(aes(x=LenderYield), data=df) +
  geom_histogram(bins=100)
ggplot(aes(x=EstimatedEffectiveYield), data=df) +
  geom_histogram(bins=100)
```

The graphs are similar to each other. Right skewed graph with an abnormal peak at the right. I will only use Borrower Rate for convenience.

### Borrower Rate

Without the high peak around at .36 the histogram is almost a right skewed graph. According to the graph, there is a very popular APR near at .36. Let's find the exact value of it.

```{r}
df %>%
  group_by(BorrowerRate) %>%
  summarise(Count=n()) %>%
  arrange(desc(Count))
```

.3177 is the most popular APR being applied.
Cutting the variable and using it as a factored variable might be more useful.

```{r}
df$BorrowerAPR.bucket <- cut(df$BorrowerAPR,breaks=10)
table(df$BorrowerAPR.bucket)
```

### Estimated Return
```{r}
ggplot(aes(x=EstimatedReturn), data=df) +
  geom_histogram(bins=30)
```

This looks a right skewed graph with outliers less than 0.0.

```{r}
ggplot(aes(x=EstimatedReturn), data=df) +
  geom_histogram(bins=100)
```

The graph with more bins shows clear outliers with negative values and more than 0.2.

```{r}
summary(df$EstimatedReturn)

df$EstimatedReturn.bucket <- cut(df$EstimatedReturn, c(-0.1,0,0.2,0.3))
table(df$EstimatedReturn.bucket)
```

There are 176 observations less than 0.0 and 80 observations more than 0.2.
```{r}
ggplot(aes(x=EstimatedReturn), data=subset(df,df$EstimatedReturn>0 & df$EstimatedReturn<0.2)) +
  geom_histogram(bins=50)
  scale_x_sqrt()
```

The graph is drawn after Estimated Return is filtered (more than 0 and less than 0.2). Similar to the previous variables, there is a peak at the right.

### Prosper Score
```{r}
ggplot(aes(x=ProsperScore
), data=df) +
  geom_histogram(binwidth=.5)

table(df$ProsperScore)
```

Prosper score is ranging from 1 to 11.

```{r}
df$ProsperScore <- factor(df$ProsperScore)
```

Prosper score is factored.

### Employment Status Duration
```{r}
ggplot(aes(x=EmploymentStatusDuration), data=df) +
  geom_histogram(bins=100)
```

This is very nice looking right skewed graph without a peak at the right.

```{r}
ggplot(aes(x=EmploymentStatusDuration), data=df) +
  geom_histogram(bins=100) +
  scale_x_sqrt()
```

Square root is applied to see a clear right skewed shape.

### CreditScoreRangeLower and CreditScoreRangeUpper
```{r}
ggplot(aes(x=CreditScoreRangeLower), data=df) +
  geom_histogram(bins=100)
ggplot(aes(x=CreditScoreRangeUpper), data=df) +
  geom_histogram(bins=100)
```

These two histograms are very similar. Instead of using these 2 variables, I will create a new variable 'CreditScoreRangeMid' that is the average of these 2.

```{r}
# Creating a new variable
df$CreditScoreRangeMid <- (df$CreditScoreRangeLower + df$CreditScoreRangeUpper) /2

ggplot(aes(x=df$CreditScoreRangeMid), data=df) +
  geom_histogram(bins=100)
```

### CurrentCreditLines, OpenCreditLines, TotalCreditLinespast7years

```{r}
ggplot(aes(x=CurrentCreditLines), data=df) +
  geom_histogram(binwidth=1)

ggplot(aes(x=OpenCreditLines), data=df) +
  geom_histogram(binwidth=1)

ggplot(aes(x=TotalCreditLinespast7years), data=df) +
  geom_histogram(binwidth=1)
```

These are nice looking right skewed histograms.

### TotalTrades
```{r}
summary(df$TotalTrades)
ggplot(aes(x=TotalTrades), data=subset(df,!is.na(TotalTrades))) +
  geom_histogram(bins=500)
```

### DebtToIncomeRatio
```{r}
summary(df$DebtToIncomeRatio)
ggplot(aes(x=DebtToIncomeRatio), data=subset(df,!is.na(DebtToIncomeRatio))) +
  geom_histogram(bins=500)
```

There is an outlier at 10.0.

```{r}
ggplot(aes(x=DebtToIncomeRatio), data=subset(df,!is.na(DebtToIncomeRatio) & DebtToIncomeRatio <= 1)) +
  geom_histogram(bins=200)
```

The graph above shows the Debt to Income Ratio that are less than or equal to 1.

### StatedMonthlyIncome
```{r}
summary(df$StatedMonthlyIncome)

ggplot(aes(x=StatedMonthlyIncome), data=subset(df,StatedMonthlyIncome<20000)) +
  geom_histogram(bins = 200)

df %>%
  filter(StatedMonthlyIncome>quantile(df$StatedMonthlyIncome,0.99)) %>%
  summarise(n=n())
```

There are 1140 people with monthly income greater than 20526.67. Most of the peole's income is around at 4667.

### MonthlyLoanPayment
```{r}
summary(df$MonthlyLoanPayment)

ggplot(aes(x=MonthlyLoanPayment), data=df) +
  geom_histogram(bins=100)
```


### New Variable

```{r}
df$ratio_monthly_loan_payment <- df$MonthlyLoanPayment / df$StatedMonthlyIncome
summary(df$ratio_monthly_loan_payment)

df <- df %>% mutate(ratio_monthly_loan_payment = ifelse(StatedMonthlyIncome==0,0,MonthlyLoanPayment / StatedMonthlyIncome))

ggplot(aes(x=ratio_monthly_loan_payment), data=df) +
  geom_histogram(bins=100)
```

The new variable of the ratio of monthly loan payment to monthly income is created but the graph is not very good since there are many outliers.

```{r}
df$ratio_monthly_loan_payment.bucket <- cut(df$ratio_monthly_loan_payment, breaks=c(-0.01,.5,12571))

summary(df$ratio_monthly_loan_payment.bucket)
```

There are only 582 number of observations that are larger than 0.5.

```{r}
ggplot(aes(x=ratio_monthly_loan_payment), data=subset(df,ratio_monthly_loan_payment<.5)) +
  geom_histogram(bins=100)
```

The above histogram is plotted with subset of the data set where ratio_monthly_loan_payment is less than 0.5. The right skewed graph can be seen clearly.


### Original Loan Amount
```{r}
ggplot(aes(x=LoanOriginalAmount), data=df) +
  geom_histogram(bins=10)
```


# Univariate Analysis

### What is the structure of your dataset?
```{r}
str(df)
```

There are 113937 observations and 86 variables.
There are a lot of factor variables and below is a list of factor variables I will use for the further analysis.

CreditGrade, Term, LoanStatus, ProsperScore, BorrowerState, Occupation, EmploymentStatus, IncomeRange

### What is/are the main feature(s) of interest in your dataset?

I am interested in finding which variable affects the credit score. And I will find if there is any correlation between income related variables and Loan Status.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

People have different interest rates, monthly income, monthly loan payment, etc. These variables might affect their capabilities of repaying their loans. And depending on their employment status, occupations and credit scores, their loan amount may be different. For instance, I am expecting that people with low credit scores will have higher interest rates.

### Did you create any new variables from existing variables in the dataset?

I created several new variables: BorrowerAPR.bucket, EstimatedReturn.bucket, CreditScoreRangeMid and ratio monthly loan payment. BorrowerAPR.bucket and EstimatedReturn.bucket are divided into intervals so that it can be used as factor variables. CreditScoreRangeMid is the average of CreditScoreRangeLower and CreditScoreRangeUpper. Ratio monthly loan payment is the ratio of monthly loan to monthly income.  



### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

After plotting many histograms from various variables, a consistent pattern can be found in the histograms. Some of them have an unusually high peak at the right of the median. I cutted such variables into distinct intervals so that I can use them with multivariable analysis.


# Bivariate Plots Section
```{r echo=FALSE, Bivariate_Plots, warning=FALSE, message=FALSE}
#install.packages('RColorBrewer')
#install.packages('alr3')
#install.packages('stats')
suppressMessages(library(RColorBrewer))
library(alr3)
library(stats)

set.seed(20022012)
df_samp <- df[sample(1:length(df$MonthlyLoanPayment), 500), ]
neams
df_samp <- df_samp[,c(5,6,9,13,16,31,50,64,68,84,85)]
names(df_samp)

#install.packages('GGally')
suppressWarnings(library(GGally))

ggpairs(df_samp,
  lower = list(continuous = wrap("points", shape = I('.'))), 
  upper = list(combo = wrap("box", outlier.shape = I('.'))))

summary(df$ratio_monthly_loan_payment)
```

According to the matrix, BorrowerRate and Estimated return are positively correlated. And there is interesting thing going on with ProsperScore and BorrowerRate. There is strong positive correlation between LoanOriginalAmount and Monthly Loan Payment.

```{r}
ggplot(aes(x=BorrowerRate,y=EstimatedReturn),data=df) +
  geom_point(size=2, alpha=0.5)

ggplot(aes(x=BorrowerRate,y=EstimatedReturn),
       data=subset(df,df$BorrowerRate<.4 & df$BorrowerRate>0)) +
  geom_point(size=2, alpha=0.5)
```

Overal plot is showing positive correlation but the plot actually shows the multiple linear lines with the same slope.

```{r}
f <-lm(formula = EstimatedReturn ~ BorrowerRate, data = subset(df, BorrowerRate <= 
  quantile(df$BorrowerRate, 0.999)))

summary(f)

cor.test(df$EstimatedReturn,df$BorrowerRate)
```

R^2 is 0.6686 and correlation is 0.8177. More analysis is required to explain the obvious linear patterns in a graph.

```{r}
ggplot(aes(x=ProsperScore,y=BorrowerRate), data=df) +
  geom_boxplot()

ggplot(aes(x=ProsperScore,y=BorrowerRate), data=subset(df,!is.na(ProsperScore))) +
  geom_boxplot()

```

NA values in ProsperScore can be ignored. And a clear pattern can be observed in this box plot. As score gets higher, borrower rate gets lower.

```{r}
ggplot(aes(x=LoanOriginalAmount,y=MonthlyLoanPayment), data=df) +
  geom_point()
```

Clear linear pattern can be observed from the graph. Interesting thing is that 3 distinct linear lines can be seen.

```{r}
ff <- lm(MonthlyLoanPayment ~ LoanOriginalAmount, data=df)

summary(ff)
cor.test(df$MonthlyLoanPayment,df$LoanOriginalAmount)
```

As a result, these two variables have very high values of R^2 and correlation. This is reasonable because those with more loan amount have to pay more.

### Ratio between monthly loan to payment

Due to huge outlier in ratio monthly loan payment variable, the graphs in the matrix don't provide good information.

```{r}
ggplot(aes(x=ratio_monthly_loan_payment,y=BorrowerRate), data=df) +
  geom_point()

ggplot(aes(y=ratio_monthly_loan_payment,x=BorrowerRate), data=subset(df,ratio_monthly_loan_payment<=.75)) +
  geom_point()

ggplot(aes(y=ratio_monthly_loan_payment,x=BorrowerRate), data=subset(df,ratio_monthly_loan_payment<=.5 & BorrowerRate<.4)) +
  geom_jitter(alpha=.1, size=2)
```

Alpha is set to 0.1 and the data is subsetted to get a better graph.

```{r}
ggplot(aes(y=ratio_monthly_loan_payment,x=EstimatedReturn), data=subset(df,ratio_monthly_loan_payment<=.2 & EstimatedReturn<0.2 & EstimatedReturn>0.0)) +
  geom_jitter(alpha=.05, size=2)
```

The graph between ratio monthly loan payment and EstimatedReturn variables shows no obvious pattern. Ratio tends to be slightly higher at 0.10 EstimatedReturn but the trend is way too subtle.

```{r}
ggplot(aes(y=ratio_monthly_loan_payment,x=Term), data=subset(df,ratio_monthly_loan_payment<=1)) +
  geom_jitter(alpha=.05, size=2) +
  geom_boxplot()

by(df$ratio_monthly_loan_payment,df$Term, summary)

df[,c(5,85)] %>%
  filter(ratio_monthly_loan_payment<=1) %>%
  group_by(Term) %>%
  dplyr::summarise(n=n())
```

Although median is the largest when the Term is 60, the mean is the largest when the Term is 36.

```{r}
ggplot(aes(y=ratio_monthly_loan_payment,x=LoanStatus), data=subset(df,ratio_monthly_loan_payment<=0.5)) +
  geom_jitter(alpha=.05, size=2) +
  geom_boxplot()

by(df$ratio_monthly_loan_payment,df$LoanStatus, summary)
```

```{r}
ggplot(aes(y=ratio_monthly_loan_payment,x=ProsperScore), data=subset(df,ratio_monthly_loan_payment<=0.5 & !is.na(ProsperScore))) +
  geom_jitter(alpha=.05, size=2) +
  geom_boxplot()

by(subset(df,ratio_monthly_loan_payment<=0.5 & !is.na(ProsperScore))$ratio_monthly_loan_payment, subset(df,ratio_monthly_loan_payment<=0.5 & !is.na(ProsperScore))$ProsperScore, summary)
```

ProsperScores of 5 and 6 tend to have a higher ratio and it gets lower as the score gets farther away from 5 and 6.

```{r}
ggplot(aes(y=ratio_monthly_loan_payment,x=CreditScoreRangeMid), 
       data=subset(df,ratio_monthly_loan_payment<=0.5 &
                     !is.na(CreditScoreRangeMid) &
                     CreditScoreRangeMid > 300)) +
  geom_jitter(alpha=.05, size=2)
```

People with good credit score tend to have a higher ratio.

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?



### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

### What was the strongest relationship you found?




# Multivariate Plots Section

```{r echo=FALSE, Multivariate_Plots}

```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection
