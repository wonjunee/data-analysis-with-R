Loan Data Exploration by Wonjun Lee
========================================================

```{r global_options, include=FALSE}
# Setting the global options
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.width=11, fig.height=11)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

suppressMessages(library(ggplot2))
```

```{r echo=FALSE, Load_the_Data}
# Load the Data
df <- read.csv("c:/udacity/data-analysis-with-R/prosperLoanData.csv")
names(df)
```

# Univariate Plots Section
```{r echo=FALSE, Univariate_Plots}
dim(df)
summary(df)
str(df)
```

There are 81 variables with 113937 observations.
Plotting a histogram for each variable will be helpful in understanding the data set. I will only use variables that are not factors.

### Finding good variables
```{r echo=FALSE, FINDING_VARIABLES}
library(dplyr)
# Finding the number of na for each column
colSums(is.na(df))
```

This will help me filter out variables with too many NA's.

### Term
```{r echo=FALSE, TERM_HISTOGRAM}
# Summarize Term variable and factor the variable
table(df$Term)
df$Term <- factor(df$Term)
```

There are only 3 terms people use. It is better to adjust the plot to show only 3 values on the x-axis.

```{r echo=FALSE, FACTORING_TERM}
# Plot bar graph for Term variable
ggplot(aes(x=Term), data=df) +
  geom_bar() +
  ggtitle("Term Histogram")
```

Now the plot shows only 3 values on the x-axis: 12, 36 and 60. Term variable will be used as a factored variable.

### Borrower Rate, Borrower APR, Lender Yield, EstimatedEffectiveYield
```{r echo=FALSE, INTEREST_RATES}
# Plot histogram for BorrowerAPR
ggplot(aes(x=BorrowerAPR), data=df) +
  geom_histogram(bins=100) +
  ggtitle("BorrowerAPR Histogram")

# Plot histogram for BorrowerRate
ggplot(aes(x=BorrowerRate), data=df) +
  geom_histogram(bins=100) +
  ggtitle("BorrowerRate Histogram")

# Plot histogram for LenderYield
ggplot(aes(x=LenderYield), data=df) +
  geom_histogram(bins=100) +
  ggtitle("LenderYield Histogram")

# Plot histogram for EstimatedEffectiveYield
ggplot(aes(x=EstimatedEffectiveYield), data=df) +
  geom_histogram(bins=100) +
  ggtitle("EstimatedEffectiveYield Histogram")
```

The graphs are similar to each other. Right skewed graph with an abnormal peak at the right. I will only use Borrower Rate for convenience.

### Borrower Rate

Without the high peak around at .36 the histogram is almost a right skewed graph. According to the graph, there is a very popular APR near at .36. Let's find the exact value of it.

```{r echo=FALSE, Find_the_most_popular_interest_rates}
# Finding the most frequently used BorrowerRate
df %>%
  group_by(BorrowerRate) %>%
  summarise(Count=n()) %>%
  arrange(desc(Count))
```

.3177 is the most popular APR being applied.
Cutting the variable and using it as a factored variable might be more useful.

```{r echo=FALSE, Cutting_APR}
# Cut BorrowerRate variable and Summarize it
df$BorrowerRate.bucket <- cut(df$BorrowerRate,breaks=10)
table(df$BorrowerRate.bucket)
```

### Estimated Return
```{r echo=FALSE, EstimatedReturnHistogram}
# Plot the histogram for EstimatedReturn 30 bins
ggplot(aes(x=EstimatedReturn), data=df) +
  geom_histogram(bins=30) +
  ggtitle("EstimatedReturn Histogram")
```

This looks a right skewed graph with outliers less than 0.0.

```{r echo=FALSE, With_more_bins}
# Plot the histogram for EstimatedReturn with 100 bins
ggplot(aes(x=EstimatedReturn), data=df) +
  geom_histogram(bins=100) +
  ggtitle("EstimatedReturn Histogram with More bins")
```

The graph with more bins shows clear outliers with negative values and more than 0.2.

```{r echo=FALSE, Investigating_Return}
# Summary of EstimatedReturn variable
summary(df$EstimatedReturn)

# Cut EstimatedReturn variable and summarize it
df$EstimatedReturn.bucket <- cut(df$EstimatedReturn, c(-0.1,0,0.2,0.3))
table(df$EstimatedReturn.bucket)
```

There are 176 observations less than 0.0 and 80 observations more than 0.2.

```{r echo=FALSE, Filtered_histogram}
# Take out outliers and replot the histogram
ggplot(aes(x=EstimatedReturn), data=subset(df,df$EstimatedReturn>0 & df$EstimatedReturn<0.2)) +
  geom_histogram(bins=50) +
  ggtitle("EstimatedReturn Histogram (Filtered)")
```

The graph is drawn after Estimated Return is filtered (more than 0 and less than 0.2). Similar to the previous variables, there is a peak at the right.

### Prosper Score
```{r echo=FALSE, Factoring_variable}
# Save numeric prosperscore for a later use
df$ProsperScore.numeric <- df$ProsperScore

# Factor ProsperScore
df$ProsperScore <- factor(df$ProsperScore)
```

Prosper score is factored.

```{r echo=FALSE, ProsperScoreHistogram}
# Plot histogram for ProsperScore
ggplot(aes(x=ProsperScore), data=df) +
  geom_bar() +
  ggtitle("ProsperScore Histogram")

# Summarize ProsperScore variable.
table(df$ProsperScore)
```

Prosper score is ranging from 1 to 11. Most of them are NAs. We can assume them people don't provide enough information for their ProsperScores.

### Employment Status Duration
```{r echo=FALSE, EmploymentStatusDurationHistogram}
# Plot histogram for EmploymentStatusDuration with 100 bins
ggplot(aes(x=EmploymentStatusDuration), data=df) +
  geom_histogram(bins=100) +
  ggtitle("EmploymentStatusDuration Histogram")
```

This is very nice looking right skewed graph without a peak at the right.

```{r echo=FALSE, Square_rooted}
# Plot histogram for EmploymentStatusDurationwith square rooted x axis
ggplot(aes(x=EmploymentStatusDuration), data=df) +
  geom_histogram(bins=100) +
  scale_x_sqrt() +
  ggtitle("EmploymentStatusDuration Histogram (Square Rooted)")
```

Square root is applied to see a clear right skewed shape.

### CreditScoreRangeLower and CreditScoreRangeUpper
```{r echo=FALSE, CreditScores}
# Plot histogram for CreditScoreRangeLower with 100 bins
ggplot(aes(x=CreditScoreRangeLower), data=df) +
  geom_histogram(bins=100) +
  ggtitle("CreditScoreRangeLower Histogram")

# Plot histogram for CreditScoreRangeUpper with 100 bins
ggplot(aes(x=CreditScoreRangeUpper), data=df) +
  geom_histogram(bins=100) +
  ggtitle("CreditScoreRangeUpper Histogram")
```

These two histograms are very similar. Instead of using these 2 variables, I will create a new variable 'CreditScoreRangeMid' that is the average of these 2.

```{r echo=FALSE, Creating_new_variable_CreditScoreMid}
# Creating a new variable
df$CreditScoreRangeMid <- (df$CreditScoreRangeLower + df$CreditScoreRangeUpper) /2

# Plot histogram for CreditScoreRangeMid with 100 bins
ggplot(aes(x=df$CreditScoreRangeMid), data=df) +
  geom_histogram(bins=100) +
  ggtitle("CreditScoreRangeMid Histogram")
```

### CurrentCreditLines, OpenCreditLines, TotalCreditLinespast7years

```{r echo=FALSE, CreditLines}
# Plot histogram for CurrentCreditLines
ggplot(aes(x=CurrentCreditLines), data=df) +
  geom_histogram(binwidth=1) +
  ggtitle("CurrentCreditLines Histogram")

# Plot histogram for OpenCreditLines
ggplot(aes(x=OpenCreditLines), data=df) +
  geom_histogram(binwidth=1) +
  ggtitle("OpenCreditLines Histogram")

# Plot histogram for TotalCreditLinespast7years
ggplot(aes(x=TotalCreditLinespast7years), data=df) +
  geom_histogram(binwidth=1) +
  ggtitle("TotalCreditLinespast7years Histogram")
```

These are nice looking right skewed histograms.

### TotalTrades
```{r echo=FALSE, TotalTrades}
# Summarize TotalTrades
summary(df$TotalTrades)

# Plot histogram for TotalTrades without na values
ggplot(aes(x=TotalTrades), data=subset(df,!is.na(TotalTrades))) +
  geom_histogram(bins=500) +
  ggtitle("TotalTrades Histogram")
```

### DebtToIncomeRatio
```{r echo=FALSE, DebtToIncomeRatio}
# Summarize DebtToIncomeRatio
summary(df$DebtToIncomeRatio)

# Plot histogram for DebtToIncomeRatio without na values
ggplot(aes(x=DebtToIncomeRatio), data=subset(df,!is.na(DebtToIncomeRatio))) +
  geom_histogram(bins=500) +
  ggtitle("DebtToIncomeRatio Histogram")
```

There is an outlier at 10.0.

```{r echo=FALSE, Taking_out_outliers}
# Plot histogram for DebtToIncomeRatio without na values and outliers
ggplot(aes(x=DebtToIncomeRatio), data=subset(df,!is.na(DebtToIncomeRatio) & DebtToIncomeRatio <= 1)) +
  geom_histogram(bins=200) +
  ggtitle("DebtToIncomeRatio Histogram")
```

The graph above shows the Debt to Income Ratio that are less than or equal to 1.

### StatedMonthlyIncome

```{r echo=FALSE, MonthlyIncome}
# Summarize StatedMonthlyIncome variable
summary(df$StatedMonthlyIncome)
```

Summary of StatedMonthlyIncome shows a huge difference between 3rd quadrant and maximum value.
This means that there are large outliers in the data.

```{r echo=FALSE, MonthlyIncome_continued}
# Plot histogram for StatedMonthlyIncome variable less than 20,000
ggplot(aes(x=StatedMonthlyIncome), data=subset(df,StatedMonthlyIncome<20000)) +
  geom_histogram(bins = 100) +
  ggtitle("StatedMonthlyIncome Histogram")
```

The histogram of StatedMonthlyIncome looks right skewed but it doesn't look very good because the counts are not continuously shaped.

```{r echo=FALSE, MonthlyIncome_continued}
# Plot histogram for StatedMonthlyIncome variable less than 20,000
# and apply sqrt to y axis
ggplot(aes(x=StatedMonthlyIncome), 
       data=subset(df,
                   StatedMonthlyIncome<20000)) +
  geom_histogram(bins = 100) +
  scale_y_sqrt() +
  ggtitle("StatedMonthlyIncome Histogram")

# Filter StatedMonthlyIncome by 99% and summarize it
df %>%
  filter(StatedMonthlyIncome>quantile(df$StatedMonthlyIncome,0.99)) %>%
  summarise(n=n())
```

After applying sqrt to y axis, the graph now looks better.
There are 1140 people with monthly income greater than 20526.67. Most of the people's income is around at 4667.

### MonthlyLoanPayment
```{r echo=FALSE, MonthlyLoanPayment}
# Summarize MonthlyLoanPayment
summary(df$MonthlyLoanPayment)

# Plot histogram for MonthlyLoanPayment
ggplot(aes(x=MonthlyLoanPayment), data=df) +
  geom_histogram(bins=100) +
  ggtitle("MonthlyLoanPayment Histogram")
```


### New Variable

```{r echo=FALSE, Creating_new_variable}
# Creating new variable. If the denominator is zero then ratio is 0.
df <- df %>% 
  mutate(ratio_monthly_loan_payment = ifelse(StatedMonthlyIncome==0,0,MonthlyLoanPayment / StatedMonthlyIncome))

# Plot histogram for ratio_monthly_loan_payment
ggplot(aes(x=ratio_monthly_loan_payment), data=df) +
  geom_histogram(bins=100) +
  ggtitle("Ratio_monthly_loan_payment Histogram")
```

The new variable of the ratio of monthly loan payment to monthly income is created. This is different from the DebtToIncomeRatio variable because it is monthly ratio. The graph is not very good since there are many outliers.

```{r echo=FALSE, Cutting_a_variable_LoanPmt}
# Cut the variable to see the number of values greater than .5 easily
df$ratio_monthly_loan_payment.bucket <- cut(df$ratio_monthly_loan_payment, breaks=c(-0.01,.5,12571))

# Summarize the bucket variable
summary(df$ratio_monthly_loan_payment.bucket)
```

There are only 582 number of observations that are larger than 0.5.

```{r}
# Plot the histogram for ratio_monthly_loan_payment less than 0.5
ggplot(aes(x=ratio_monthly_loan_payment), data=subset(df,ratio_monthly_loan_payment<.5)) +
  geom_histogram(bins=100) +
  ggtitle("Ratio_monthly_loan_payment Histogram (Filtered)")
```

The above histogram is plotted with subset of the data set where ratio_monthly_loan_payment is less than 0.5. The right skewed graph can be seen clearly.

### Original Loan Amount
```{r echo=FALSE, OriginalLoanAmt}
# Plot histogram for LoanOriginalAmount
ggplot(aes(x=LoanOriginalAmount), data=df) +
  geom_histogram(bins=10) +
  ggtitle("LoanOriginalAmount Histogram")
```


# Univariate Analysis

### What is the structure of your dataset?
```{r echo=FALSE, StructureOfData}
# Structure of the dataset
str(df)
```

There are 113937 observations and 86 variables.
There are a lot of factor variables and below is a list of factor variables I will use for the further analysis.

CreditGrade, Term, LoanStatus, ProsperScore, BorrowerState, Occupation, EmploymentStatus, IncomeRange

### What is/are the main feature(s) of interest in your dataset?

I am interested in finding which variable affects the credit score. And I will find if there is any correlation between income related variables and Loan Status.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

People have different interest rates, monthly income, monthly loan payment, etc. These variables might affect their capabilities of repaying their loans and their credit scores and prosper scores. And depending on their employment status, occupations and credit scores, their loan amount may be different. For instance, I am expecting that people with low credit scores will have higher interest rates.

### Did you create any new variables from existing variables in the dataset?

I created several new variables: BorrowerAPR.bucket, EstimatedReturn.bucket, CreditScoreRangeMid and ratio monthly loan payment. BorrowerAPR.bucket and EstimatedReturn.bucket are divided into intervals so that it can be used as factor variables. CreditScoreRangeMid is the average of CreditScoreRangeLower and CreditScoreRangeUpper. Ratio monthly loan payment is the ratio of monthly loan to monthly income.  



### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

After plotting many histograms from various variables, a consistent pattern can be found in the histograms. Some of them have an unusually high peak at the right of the median. I cutted such variables into distinct intervals so that I can use them with multivariable analysis.


# Bivariate Plots Section
```{r echo=FALSE, Bivariate_Plots, warning=FALSE, message=FALSE, fig.width=15, fig.height=15}
#install.packages('RColorBrewer')
#install.packages('alr3')
#install.packages('stats')
suppressMessages(library(RColorBrewer))

# Take 1000 random samples from dataset
set.seed(20022012)
df_samp <- df[sample(1:length(df$MonthlyLoanPayment), 1000), ]

# Take only 8 columns for ggpairs
df_samp <- df_samp[,c(6,9,13,16,50,64,68,85)]
names(df_samp)

#install.packages('GGally')
suppressWarnings(library(GGally))

# Plot ggpairs
ggpairs(df_samp,
  lower = list(continuous = wrap("points", shape = I('.'))), 
  upper = list(combo = wrap("box", outlier.shape = I('.')))) +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank()
  ) 
```

According to the matrix, BorrowerRate and Estimated return are positively correlated. And there is interesting thing going on with ProsperScore and BorrowerRate. There is strong positive correlation between LoanOriginalAmount and Monthly Loan Payment.

```{r echo=FALSE, Score_vs_Rate}
# Plot a scatter plot between CreditScoreRangeMid and BorrowerRates
ggplot(aes(y=BorrowerRate,x=CreditScoreRangeMid), data=df) +
  geom_point(alpha=0.01,size=2) +
  ggtitle("CreditsScoreRangeMid vs. BorrowerRate")
```

As expected, Credit Score and BorrowerRate are negatively correlated.

```{r echo=FALSE, Rate_vs_Score_CorTest}
# Plot a scatter plot between CreditScoreRangeMid and BorrowerRates filtered on CreditScoreRangeMid greater than 300
ggplot(aes(y=BorrowerRate,x=CreditScoreRangeMid), 
       data=subset(df,CreditScoreRangeMid>300)) +
  geom_jitter(alpha=0.01,size=2) +
  ggtitle("CreditScoreRangeMid vs. BorrowerRate")

# Correlation test between CreditScoreRangeMid and BorrowerRate
cor.test(subset(df,CreditScoreRangeMid>400)$BorrowerRate,
         subset(df,CreditScoreRangeMid>400)$CreditScoreRangeMid, 
         type='pearson')
```

Outliers are removed. Correlation test shows a moderate value of negative correlation.

```{r echo=FALSE, Score_vs_Rate_Filtered}
# Plot a scatter plot between ProsperScore and BorrowerRate
ggplot(aes(x=ProsperScore,y=BorrowerRate), data=df) +
  geom_boxplot() +
  ggtitle("ProsperScore vs. BorrowerRate")

# Plot a scatter plot between ProsperScore and BorrowerRate without NA values
ggplot(aes(x=ProsperScore,y=BorrowerRate), data=subset(df,!is.na(ProsperScore))) +
  geom_boxplot() +
  ggtitle("ProsperScore vs. BorrowerRate without NA")

```

NA values in ProsperScore can be ignored. And a clear pattern can be observed in this box plot. As score gets higher, borrower rate gets lower.

```{r echo=FALSE, LoanAmt_vs_Pmt}
# Plot a scatter plot between LoanOriginalAmount and MonthlyLoanPayment
ggplot(aes(x=LoanOriginalAmount,y=MonthlyLoanPayment), data=df) +
  geom_point() +
  ggtitle("LoanOriginalAmount vs. MonthlyLoanPayment")
```

Clear linear pattern can be observed from the graph. Interesting thing is that 3 distinct linear lines can be seen.

```{r echo=FALSE, CorTest}
# Create linear model between LoanOriginalAmount and MonthlyLoanPayment
ff <- lm(MonthlyLoanPayment ~ LoanOriginalAmount, data=df)

# Correlation Test between LoanOriginalAmount and MonthlyLoanPayment
cor.test(df$MonthlyLoanPayment,df$LoanOriginalAmount)
```

As a result, these two variables have very high values of R^2 and correlation. This is reasonable because those with more loan amount have to pay more.

### Ratio between monthly loan to payment

```{r echo=FALSE, Rate_vs_Ratio}
# Plot a scatter plot between BorrowerRate and ratio_monthly_loan_payment
ggplot(aes(y=ratio_monthly_loan_payment,x=BorrowerRate), data=df) +
  geom_point() +
  ggtitle("BorrowerRate vs. ratio_monthly_loan_payment")
```

Due to huge outlier in ratio monthly loan payment variable, the graphs in the matrix don't provide good information.

```{r echo=FALSE, Rate_vs_Ratio_More}
# Scatter plot between BorrowerRate and ratio_monthly_loan_payment
ggplot(aes(y=ratio_monthly_loan_payment,x=BorrowerRate), 
       data=subset(df,
                  ratio_monthly_loan_payment<=.5 & 
                  BorrowerRate<.4)) +
  geom_jitter(alpha=.1, size=2) +
  ggtitle("BorrowerRate vs. ratio_monthly_loan_payment (jitter plot)")
```

Outliers are removed and alpha is set to 0.1 and the data is subsetted to get a better graph.

```{r echo=FALSE, Return_vs_Ratio}
# Scatter plot between EstimatedReturn and ratio_monthly_loan_payment
ggplot(aes(y=ratio_monthly_loan_payment,x=EstimatedReturn), 
       data=subset(df,
                  ratio_monthly_loan_payment<=.2 & 
                  EstimatedReturn<0.2 & EstimatedReturn>0.0)) +
  geom_jitter(alpha=.05, size=2) +
  ggtitle("EstimatedReturn vs. ratio_monthly_loan_payment")
```

The graph between ratio monthly loan payment and EstimatedReturn variables shows no obvious pattern. Ratio tends to be slightly higher at 0.10 EstimatedReturn but the trend is way too subtle.

```{r echo=FALSE, Term_vs_Ratio}
# Scatter plot between Term and ratio_monthly_loan_payment
ggplot(aes(y=ratio_monthly_loan_payment,x=Term), 
       data=subset(df,ratio_monthly_loan_payment<=1)) +
  geom_jitter(alpha=.05, size=2) +
  ggtitle("Term vs. ratio_monthly_loan_payment")

# Summarize ratio_monthly_loan_payment by Term variable
by(df$ratio_monthly_loan_payment,df$Term, summary)

# Filter ratio_monthly_loan_payment less or equal to 1 and group by Term
df %>%
  filter(ratio_monthly_loan_payment<=1) %>%
  group_by(Term) %>%
  summarise(n=n())
```

Although median is the largest when the Term is 60, the mean is the largest when the Term is 36.

```{r echo=FALSE, LoanStatus_vs_Ratio, fig.width=11, fig.height=11}
# Scatter Plot between LoanStatus and ratio_monthly_loan_payment 
ggplot(aes(y=ratio_monthly_loan_payment,x=LoanStatus), 
       data=subset(df,ratio_monthly_loan_payment<=0.5)) +
  geom_jitter(alpha=.05, size=2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("LoanStatus vs. ratio_monthly_loan_payment")
```

Completed status tends to have larger value for ratio monthly loan payment. And Defaulted status has low ratio.

```{r echo=FALSE, Status_vs_Income, fig.width=11, fig.height=11}
# Jitter plot between LoanStatus and StatedMonthlyIncome excluding outliers.
ggplot(aes(y=StatedMonthlyIncome,x=LoanStatus), 
       data=subset(df,StatedMonthlyIncome<50000)) +
  geom_jitter(alpha=.05, size=2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("LoanStatus vs. StatedMonthlyIncome (filtered by income<50000)")

# Summarize StatedMonthlyIncome by LoanStatus
by(df$StatedMonthlyIncome, df$LoanStatus, summary)
```

Completed people have greater incomes than Defaulted people.

```{r echo=FALSE, Status_vs_Rate , fig.width=11, fig.height=11}
# Jitter plot between LoanStatus and BorrowerRate
ggplot(aes(y=BorrowerRate,x=LoanStatus), 
       data=df) +
  geom_jitter(alpha=.05, size=2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("LoanStatus vs. BorrowerRate")

# Summarize BorrowerRate by LoanStatus
by(df$BorrowerRate, df$LoanStatus, summary)
```

People with less borrower rates complete their loan payments better than those with higher rates.

```{r echo=FALSE, Score_vs_Ratio}
# Jitter plot between ProsperScore and ratio_monthly_loan_payment
ggplot(aes(y=ratio_monthly_loan_payment,x=ProsperScore), 
       data=subset(df,
                   ratio_monthly_loan_payment<=0.5 & 
                     !is.na(ProsperScore))) +
  geom_jitter(alpha=.05, size=2) +
  ggtitle("ProsperScore vs. ratio_monthly_loan_payment")

# Exclude outliers and take out na values
filtered_ratio <- subset(df,ratio_monthly_loan_payment<=0.5 & !is.na(ProsperScore))

# Summarize ratio_monthly_loan_payment by ProsperScore
by(filtered_ratio$ratio_monthly_loan_payment, 
   filtered_ratio$ProsperScore, summary)
```

ProsperScores of 5 and 6 tend to have a higher ratio and it gets lower as the score gets farther away from 5 and 6.

```{r echo=FALSE, Score_vs_Ratio_Filtered}
# jitter plot between CreditScoreRangeMid and ratio_monthly_loan_payment
# filter ratio less or equal to 0.5 and CreditScoreRangeMid without na values and greater than 300
ggplot(aes(y=ratio_monthly_loan_payment,x=CreditScoreRangeMid), 
       data=subset(df,ratio_monthly_loan_payment<=0.5 &
                     !is.na(CreditScoreRangeMid) &
                     CreditScoreRangeMid > 300)) +
  geom_jitter(alpha=.05, size=2) +
  ggtitle("CreditScoreRangeMid vs. ratio_monthly_loan_payment")
```

People with 700 credit score tend to have the highest ratio.

```{r echo=FALSE, Prosper_vs_credit}
# Summarize CreditScoreRangeUpper
table(df$CreditScoreRangeUpper)

# jitter plot ProsperScore and CreditScoreRangeMid
# filter CreditScorerANGEmID Without na values and greater than 300
ggplot(aes(x=ProsperScore,y=CreditScoreRangeMid), 
       data=subset(df,!is.na(CreditScoreRangeMid) &
                     CreditScoreRangeMid > 300 &
                     !is.na(ProsperScore))) +
  geom_jitter(alpha=.05, size=2) +
  geom_boxplot() +
  ggtitle("ProsperScore vs. CreditScoreRangeMid")
```

Interesting thing here is that the credit score is increasing until the prosper score 10 and it decreases when the prosper score is 11. People with really nice credit scores have a prosper score of 10.

```{r echo=FALSE, Occupation_vs_LoanAmt, fig.width=11, fig.height=11}
# jitter plot between Occupation and LoanOriginalAmount.
# Rotate the axis labels 
ggplot(aes(x=Occupation,y=LoanOriginalAmount), 
       data=df) +
  geom_jitter(alpha=.05, size=2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Occupation vs. LoanOriginalAmount")
```

This is a graph of Occupation and Loan amount. Since there are too many occupations and these occupations have to be grouped so that more clear pattern can be observed. But I decided not to use Occupation this time.

```{r echo=FALSE, Score_vs_LoanAmt_CorTest}
# jitter plot between CreditScoreRangeMid and LoanOriginalAmount
# filter CreditScoreRangeMid greater than 350
ggplot(aes(x=CreditScoreRangeMid,y=LoanOriginalAmount), 
       data=subset(df,CreditScoreRangeMid>350)) +
  geom_jitter(alpha=.05, size=2) +
  ggtitle("CreditScoreRangeMid vs. LoanOriginalAmount")

# Linear model between CreditScoreRangeMid and LoanOriginalAmount
f <- lm(LoanOriginalAmount ~ CreditScoreRangeMid,data=subset(df,CreditScoreRangeMid>350))
summary(f)
```

R^2 is very small so it is difficult to say there exists a linear relationship between this two variables, but generally people with good credit score have greater loan amounts.

```{r echo=FALSE, Score_vs_Income}
# jitter plot between CreditScore and Monthly Income
# filter CreditScoreRangeMid greater than 300
ggplot(aes(x=CreditScoreRangeMid,y=StatedMonthlyIncome), 
       data=subset(df,
                     CreditScoreRangeMid>300)) +
  geom_jitter(alpha=.01,size=2) +
  ggtitle("CreditScore vs. Monthly Income")

# Jitter plot more filters. 
# StateMonthly Income greater than 10 and apply log scale on StatedMonthlyIncome
ggplot(aes(x=CreditScoreRangeMid,y=StatedMonthlyIncome), 
       data=subset(df,
                     CreditScoreRangeMid>300 &
                     StatedMonthlyIncome>10)) +
  geom_jitter(alpha=.01,size=2) +
  scale_y_log10() +
  ggtitle("CreditScore vs. log(Monthly Income)")

# Create subset where StatedMonthlyIncome greater than 10
filter_monthlyIncome <- subset(df,StatedMonthlyIncome >10)

# Linear Model between CreditScoreRangeMid and StatedMonthlyIncome
f <- lm(log(filter_monthlyIncome$StatedMonthlyIncome) ~ filter_monthlyIncome$CreditScoreRangeMid)
summary(f)

cor.test(filter_monthlyIncome$StatedMonthlyIncome, filter_monthlyIncome$CreditScoreRangeMid)
cor.test(log(filter_monthlyIncome$StatedMonthlyIncome), filter_monthlyIncome$CreditScoreRangeMid)
```

CreditScoreRangeMid vs. StatedMonthlyIncome was graphed without any modification. And then log of monthly income is graphed. The latter showed more linearlized graph and the correlation was higher.

```{r echo=FALSE, Income_vs_Amt}
# jitter plot between StatedMonthlyIncome and LoanOriginalAmount
# apply log scale on x axis and filter statedMonthlyIncome greater than 10
ggplot(aes(x=StatedMonthlyIncome,y=LoanOriginalAmount), 
       data=subset(df,StatedMonthlyIncome>10)) +
  scale_x_log10() +
  geom_jitter(alpha=.01, size=2) +
  ggtitle("Log of StatedMonthly Income vs. Loan Amount")

# Linear Model between StatedMonthlyIncome and LoanOriginalAmount
f <- lm(LoanOriginalAmount ~ StatedMonthlyIncome, data=subset(df,StatedMonthlyIncome>10))
summary(f)

# Correlation test between LoanOriginalAmount and log of StatedMonthlyIncome 
cor.test(subset(df,StatedMonthlyIncome>10)$LoanOriginalAmount, 
         log(subset(df,StatedMonthlyIncome>10)$StatedMonthlyIncome))
```

There is a linear relationship between the log of monthly income and loan amount.
There are clear horizontal lines at multiple of 5000. I believe when the data is gathered the loan amounts are rounded.
People whose monthly income is less than 8000 don't usually have laon amounts greater than 25,000.

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

From the plots above, people with lower borrower rates and higher incomes tend to complete their loan payments better than those with higher borrower rates and lower incomes.

I created a new variable, the ratio of monthly loan payment to monthly income. I was interested in this rate because it can be an important factor to people when they repay their loans. Students can have lower incomes if they don't get jobs they expected to get after graduation. In this case, a great portion of their incomes has to be paid as their loans. I thought that I can get a slight idea of unemployemnt rates from this analysis.

As a result, people who completed repaying their loans have lower rate than people who defaulted their loans. And people with the highest Prosper Score and Credit Score have lower ratio.

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

I thought that when a borrower rate is high then the return rate will be lower, but the opposite phenomenon can be seen from the graph. They are showing the positive correlation.

And I thought that the ratio of monthly loan payment to monthly income will be greater for those with better credit scores. However, the ratio is the greatest when the score is 5 or 6. Then I analyzed the relationship between the score and the monthly income. As a result, those with greater income amounts have better credit scores. This explains the ratio at 5 or 6 is greater than higher scores because people with a good income don't increase their loan payment amount.

### What was the strongest relationship you found?

The strongest relationship I found was Monthly Loan Payment and Loan Amount. And the Borrower Rate and Prosper Score also showed a strong relationship.

# Multivariate Plots Section

```{r echo=FALSE, Multivariate_Plots}
# jitter plot between CreditScoreRangeMid and ratio_monthly_loan_payment with color of ProsperScore
# Only using ProsperScore from 1 to 5
# Using scale brewer sequential type
ggplot(aes(x=CreditScoreRangeMid,y=ratio_monthly_loan_payment,color=ProsperScore), 
       data=subset(df,!is.na(ProsperScore) &
                     ratio_monthly_loan_payment<=1 &
                    ProsperScore %in% c(1,2,3,4,5))) +
  geom_jitter(alpha=0.5,size=2) +
  scale_color_brewer(type='seq') +
  theme_dark() +
  ggtitle("CreditScoreRangeMid vs. ratio_monthly_loan_payment colored by Bad ProsperScores")

# jitter plot between CreditScoreRangeMid and ratio_monthly_loan_payment with color of ProsperScore
# Only using ProsperScore from 6 to 10
ggplot(aes(x=CreditScoreRangeMid,y=ratio_monthly_loan_payment,color=ProsperScore), 
       data=subset(df,!is.na(ProsperScore) &
                     ratio_monthly_loan_payment<=1 &
                    ProsperScore %in% c(6,7,8,9,10,11))) +
  geom_jitter(alpha=0.5,size=2) +
  scale_color_brewer(type='seq') +
  theme_dark() +
  ggtitle("CreditScoreRangeMid vs. ratio_monthly_loan_payment colored by Good ProsperScores")
```

I plotted two similar plots: one with low ProsperScores and the other with high ProsperScores. This is because scale color brewer sequential only takes 9 colors and it cannot color beyond 9.

```{r echo=FALSE, Multivariate_Plots_continued}
# Cutting ProsperScore
df$ProsperScore.bucket <- cut(df$ProsperScore.numeric, breaks = c(0,2,4,6,8,10,12))
table(df$ProsperScore.bucket)
```

Cutted the ProsperScore in order to use scale color brewer.

```{r echo=FALSE, Multivariate_Plots_continued_2}
# jitter plot between CreditScoreRangeMid and ratio_monthly_loan_payment with color of ProsperScore
# facet wrapped by BorrowerRate.bucket
# Using scale brewer sequential type
ggplot(aes(x=CreditScoreRangeMid,y=ratio_monthly_loan_payment,color=ProsperScore.bucket), 
       data=subset(df,!is.na(ProsperScore) &
                     ratio_monthly_loan_payment<=1)) +
  geom_jitter(size=2) +
  scale_color_brewer(type='seq') +
  theme_dark() +
  facet_wrap(~BorrowerRate.bucket) +
  ggtitle("Facet Wrap by Borrower APR")
```

I plotted ratio monthly loan payment of credit score for each BorrowerRate bucket. Good prosper scores can be found in the range of 0.0571 to 0.108 of a borrower rate. And they also have a good credit scores. As the borrower rate increases, the prosper score and credit score decrease.

```{r echo=FALSE, Loan_Pmt_ProsperScore}
# Jitter plot between LoanOriginalAmount and MonthlyLoanPayment
# colored by ProsperScorebucket
ggplot(aes(x=LoanOriginalAmount,y=MonthlyLoanPayment,color=ProsperScore.bucket),
       data=df) +
  geom_jitter(alpha=0.5, size=2) +
  scale_color_brewer(type='seq') +
  theme_dark() +
  ggtitle("LoanOriginalAmount vs. MonthlyLoanPayment colored by ProsperScore")
```

The line with the largest slope mainly contains low prosper scores. Note that those with ProsperScore of 11 usually are on the lines that have slope of 1/30 or 1/50.

```{r echo=FALSE, LoanAmt_LoanPmt_ProsperScore_APR}
# Facet Wrapped by BorrowerRate
ggplot(aes(x=LoanOriginalAmount,y=MonthlyLoanPayment,color=ProsperScore.bucket),
       data=subset(df,!is.na(ProsperScore))) +
  geom_jitter(size=2) +
  scale_color_brewer(type='seq') +
  theme_dark() +
  facet_wrap(~BorrowerRate.bucket) +
  ggtitle("Facet Wrap by BorrowerRate")
```

The graph is faceted by BorrowerRate. More obvious pattern can be observed. People with good ProsperScore are in the ranges of the low borrower rates and those with bad scores are in the ranges of the high rates. As the Borrower rate gets larger, the score gets lower. And people with higher borrower rates don't have large loan amounts. When you look at Borrower Rate bucket from 0.298 to 0.398, the loan amounts don't exceed 20,000.

```{r echo=FALSE, Ratio_LoanPmt_CreditScore}
# jitter plot between CreditScoreRangeMid and monthly ratio of loan payment
# colored by ProsperScore.
# Filter monthly ratio less than or equal to 0.5 and no na values
# and CreditScoreRangeMid greater than 300
ggplot(aes(y=ratio_monthly_loan_payment,x=CreditScoreRangeMid,color=ProsperScore), 
       data=subset(df,ratio_monthly_loan_payment<=0.5 &
                     !is.na(CreditScoreRangeMid) &
                     !is.na(ProsperScore) &
                     CreditScoreRangeMid > 300)) +
  geom_jitter(alpha=.5, size=2) +
  ggtitle("CreditScoreRangeMid vs. ratio_monthly_loan_payment colored by ProsperScore")

```

From the previous plot, the positive correlation between CreditScore and ProsperScore is already observed. What's interesting to note in this graph is that those with good prosperScore don't usually pay more than 20% of their income for their loan payments.

```{r echo=FALSE, CreditScore_Ratio_EmpStatus}
# jitter plot between CreditScoreRangeMid and ratio_monthly_loan_payment
# colored by EmploymentStatus and facet wrapped by LoanStatus
ggplot(aes(y=ratio_monthly_loan_payment,x=CreditScoreRangeMid,color=EmploymentStatus), 
       data=subset(df,ratio_monthly_loan_payment<=0.5 &
                     !is.na(CreditScoreRangeMid) &
                     EmploymentStatus != "Employed" &
                     EmploymentStatus != "Not available" &
                     EmploymentStatus != "Other" &
                     EmploymentStatus != "" &
                     CreditScoreRangeMid > 300)) +
  geom_jitter(alpha=.5, size=2) +
  scale_color_brewer(type='qual') +
  facet_wrap(~LoanStatus) +
  ggtitle("Facet Wrap by Loan Status")
```

Chargedoff, Completed and Defaulted are similar. Most of them are Full time. Interesting thing to note is that most of the people who is currently paying their loans are self-employed.

```{r echo=FALSE, Cutting_a_variable_Income}
# Cutting StatedMonthlyIncome
df$StatedMonthlyIncome.bucket <- cut(df$StatedMonthlyIncome,breaks=c(0,1000,2000,3000,4000,5000,6000,7000,8000,1.75e+06))
table(df$StatedMonthlyIncome.bucket)
```

The StatedMonthlyIncome is cutted into 9 intervals.

```{r echo=FALSE, ProsperScore_Rate_Income}
# jitter plot between ProsperScore and BorrowerRate
# colored by StatedMonthlyIncome with labels
ggplot(aes(x=ProsperScore,y=BorrowerRate,color=StatedMonthlyIncome.bucket), 
       data=df) +
  geom_jitter(alpha=.5, size=2) +
  scale_color_brewer(labels=c("$0-$3000", 
                              "$1000-$2000", 
                              "$2000-$3000", 
                              "$3000-$4000", 
                              "$4000-$5000", 
                              "$5000-$6000", 
                              "$6000-$7000", 
                              "$7000-$8000", 
                              ">$8000"
                              ), 
                     type='seq') +
  theme_dark() +
  ggtitle("ProsperScore vs. BorrowerRate colored by Monthly Income")
```

This graph also shows that people with high income levels have high Prosper Score and low Borrower Rate.

```{r echo=FALSE, Investigating_Occupation}
# Find the occupations with the largest Credit Scores
df %>%
  group_by(Occupation) %>%
  summarise(count=n(), 
            CreditScoreRangeMid_mean=mean(CreditScoreRangeMid)) %>%
  arrange(desc(CreditScoreRangeMid_mean))

# Find the occupations with the lowest Credit Scores
df %>%
  group_by(Occupation) %>%
  summarise(count=n(), 
            CreditScoreRangeMid_mean=mean(CreditScoreRangeMid)) %>%
  arrange(CreditScoreRangeMid_mean)
```

There are 68 different occupations in the data set.
According to the table above the counts for some occupations are less than 1000. I will filter out such people whose count is less than 1000.

```{r echo=FALSE, Further_investigation}
# Find the occupation with the largest Credit Scores
# where n is above 1000 counts
df %>%
  group_by(Occupation) %>%
  summarise(count=n(), 
            CreditScoreRangeMid_mean=mean(CreditScoreRangeMid)) %>%
  filter(count>1000) %>%
  arrange(desc(CreditScoreRangeMid_mean))

# Find the occupation with the lowest Credit Scores
# where n is above 1000 counts
df %>%
  group_by(Occupation) %>%
  summarise(count=n(), 
            CreditScoreRangeMid_mean=mean(CreditScoreRangeMid)) %>%
  filter(count>1000) %>%
  arrange(CreditScoreRangeMid_mean)

# this list has 4 occupations with the highest credit scores
# and 4 occupations with the lowest credit scores
Occupation_lists <- c("Attorney",
                      "Engineer - Electrical",
                      "Executive",
                      "Computer Programmer",
                      "Clerical",
                      "Laborer",
                      "Food Service",
                      "Sales - Retail")
```

This list has 4 occupations with the highest credit scores and 4 occupations with the lowest credit scores for the further analysis.

```{r echo=FALSE, ProsperScore_Ratio_Occupation}
# jitter plot between ProsperScore and BorrowerRate colored by Occupation
# only using 10 occupations in Occupation_lists
ggplot(aes(y=BorrowerRate, x=ProsperScore, color=Occupation),
       data=subset(df,
                   Occupation %in% Occupation_lists &
                     LoanStatus %in% c( "Defaulted"))) +
         geom_jitter(alpha=1, size=2) +
  scale_color_brewer(type='qual') +
  ggtitle("ProsperScore vs. BorrowerRate colored by Occupation")
```

ProsperScore vs. BorrowerRate is plotted with color of Occupations. Unfortunately, too many points are NA so this plot cannot be used for the analysis.

```{r echo=FALSE, ProsperScore_Rate_Status}
# Jitter plot between ProsperScore and Borrower Rate
# colored by EmploymentStatus
ggplot(aes(y=BorrowerRate, x=ProsperScore, color=EmploymentStatus),
       data=subset(df,
                   EmploymentStatus != "" & 
                     EmploymentStatus != "Employed" &
                     EmploymentStatus != "Other" &
                     !is.na(ProsperScore))) +
         geom_jitter(alpha=1, size=2) +
  scale_color_brewer(type='qual') +
  ggtitle("ProsperScore vs. BorrowerRate colored by EmploymentStatus")
```

full-time people are at the right bottom corner and Self-employed people are at the left hand side.
And those with ProsperScore 11 are mostly self-employed.


## Linear Model

Based on the observations so far, I can build a model using, OriginalLoanAmount, MonthlyLoanPayment, ProsperScore, Borrower Rate, EmploymentStatus and CreditScore.

```{r echo=FALSE, Constructing_Linear_Model}
# Creating linear models using variables of my interest
library(memisc)

df_reduced <- subset(df,MonthlyLoanPayment>10)
m1 <- lm(ProsperRating..numeric. ~ BorrowerRate, data = df_reduced)
m2 <- update(m1, ~ . + LoanOriginalAmount)
m3 <- update(m2, ~ . + log(MonthlyLoanPayment))
m4 <- update(m3, ~ . + CreditScoreRangeMid)
m5 <- update(m4, ~ . + EmploymentStatus)

mtable(m1, m2, m3, m4, m5, sdigits=3)
```

R_squared gets increased as variables are added. The result R-squared is 0.917 which means a positive correlation.

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

I found that those with good Prosper Scores tend to complete their payments better than those with bad Prosper Scores. So I decided to focus on finding which variables affect the prosper scores.
I found that there monthly income, credit score, original loan amount, monthly loan payment are positively correlated to Prosper Score and Borrower Rate is negatively correlated to Prosper Score. In other words, the capability of completing the loan payments depend on these variables.

### Were there any interesting or surprising interactions between features?

The most interesting thing I found was that that are many people who pay their loans with 0 income. And it was also interesting to find out that most of them actually completed their loan payments.
Another interesting interaction was between the credit score and ratio between monthly loan payment to monthly income. People in mid range of credit scores have the highest ratio. People 

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

I created a model starting from ProsperRating..numeric. and BorrowerRate. ProsperRating..numeric. is used instaed of ProsperScore because it is a numeric variable while ProsperScore is a factor variable.
Then I added 4 more variables: LoanOriginalAmount, log(monthlyLoanPayment), CreditScoreRangeMid and EmploymentStatus.
R-squared was 0.909 at first. When more variables are added to the model, it gets increased until 0.917.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}
# Bar graph of ProsperScore without na values
ggplot(aes(x=ProsperScore), data=subset(df, !is.na(ProsperScore))) +
  geom_bar() +
  ggtitle("ProsperScore Histogram")
```

### Description One

This is a histogram of ProsperScore variable. It looks similar to the normal distribution graph. Most of the people have ProsperScore between 4 and 8 and a small number of poeple are outside this range.

### Plot Two
```{r echo=FALSE, Plot_Two}
# Jitter plot between ProsperScore and BorrowerRate
ggplot(aes(x=ProsperScore,y=BorrowerRate), 
       data=subset(df,!is.na(ProsperScore))) +
  geom_jitter(alpha=0.05,size=2) +
  ggtitle("ProsperScore vs. BorrowerRate")
```

### Description Two

This graph shows that ProsperScore and BorrowerRate are negatively correlated. As the box plot shows the median values decrease as the ProsperScore increases.

### Plot Three
```{r echo=FALSE, Plot_Three}
# Jitter plot between ProsperScore and CreditScoreRangeMid
# Colored by StatedMonthlyIncome
ggplot(aes(x=ProsperScore.numeric,y=CreditScoreRangeMid,color=StatedMonthlyIncome.bucket), 
       data=subset(df,!is.na(ProsperScore))) +
  geom_jitter(alpha=.5, size=2) +
  geom_smooth() +
  scale_x_continuous(breaks=seq(1,11)) +
  scale_color_brewer(labels=c("$0-$3000", 
                              "$1000-$2000", 
                              "$2000-$3000", 
                              "$3000-$4000", 
                              "$4000-$5000", 
                              "$5000-$6000", 
                              "$6000-$7000", 
                              "$7000-$8000", 
                              ">$8000"), 
                     type='seq') +
  theme_dark() +
  labs(x="ProsperScore", colour = "Monthly Income") +
  ggtitle("ProsperScore vs. CreditScoreRangeMid colored by Monthly Income")
```

### Description Three

Through this graph, the linear model can be constructed using ProsperScore, CreditScore and Monthly Income.
This graph shows the that people with good ProsperScore and CreditScore have large monthly income and people with bad ProsperScore and CreditScore have low monthly income. Note that at prosperScore less than 5 the smooth line of $0-$3000 is above the others but when the prosper score is greater than 7 the line is at the bottom. 

------

# Reflection

There are total 113937 records with 81 variables in the data. I first filtered out the variables with too many NA values. Then, I analyzed each variable by creating a histogram and try to find variables that are important to this data set. There are some variables that got my attention: BorrowerRate, BorrowerAPR, CreditScore, ProsperScore, etc. I put the most emphasis on ProsperScore because according to the description of the data set, ProsperScore indicates the risk of repaying loans where 10 means the lowest risk and 0 means the highest risk. Since there are total 81 variables in the data set there are so many interesting variables I wanted to investigate further such as listing category that indicates the types of loan and BorrowerState that indicates the state of the address of the borrower. However, I decided to focus on finding the variables that affect the ProsperScore.

While the univariate analysis provides me which variables would be interesting to use, bivariate analysis provides the relationship between pairs of data variables I chose to use. One interesting I found during the analysis was that people who have good ProsperScore tends to have low BorrowerRate and high credit score. And people who pay their loans using higher ratio to their monthly income usually have middle range of credit scores and prosper scores. Those with high credit scores and prosper scores don't use high ratio. Later investigation showed that although people with high ratio and with low ratio pay similar amounts of loan payments those with high prosper score usually have higher monthly income. So, people with high income and high prosper score not neccessarily pay more loans.

There are few problems I confronted during the analysis. When using MonthlyIncome variable, there a lot of outliers that are way beyond the average and median of the data. At first I filtered those outliers and I realized that I have to get rid of too many of the data. So I used log10 and it provided the better histogram and plot of the data.

As I mentioned there are still a lot of interesting variables that can provide interesting results from further analysis. I would be interesting to find which state has the greatest loan amount borrowed and highest percentage of completing their loans. And I would like to find which type of loan has the highest percentage of completion and highest average mean and median of prosper score and Credit score.